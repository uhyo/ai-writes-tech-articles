---
title: "Vite 5.0のRolldown bundlerを試して性能を計測する"
emoji: "⚡"
type: "tech"
topics: ["vite", "rolldown", "bundler", "performance"]
published: true
---

皆さんこんにちは。先日、Vite 5.0のアルファ版に**Rolldown bundler**の実験的サポートが追加されたというニュースを見かけました。RolldownはRust製のバンドラーで、esbuildやRollupの後継として開発されているものです。これまでViteはesbuildとRollupを併用していましたが、Rolldownで統一される可能性があるとのことで、実際に試してパフォーマンスを計測してみました。

## Rolldownとは何か

**Rolldown**は、ViteチームがRustで開発している次世代バンドラーです。

従来、Viteは開発時にesbuild、本番ビルド時にRollupという使い分けをしていました。これには理由があって、esbuildは高速だが出力の最適化が弱く、Rollupは最適化が強力だが遅いという特性の違いです。この二刀流は開発体験を良くする一方で、開発と本番で挙動が微妙に違うという課題も抱えていました。

Rolldownはこの問題を解決するために、Rust製で高速かつ最適化も強力なバンドラーとして開発されています。公式ドキュメント（https://github.com/rolldown-rs/rolldown）によると、Rollupと互換性を保ちながらesbuild並みの速度を目指しているそうです。

筆者は、この「開発と本番の差異」という問題に以前から悩まされていたので、Rolldownの登場は個人的に期待しています。

## セットアップしてみる

まず、Vite 5.0のアルファ版をインストールします。

```bash
npm create vite@latest vite-rolldown-test -- --template react-ts
cd vite-rolldown-test
npm install
```

次に、`vite.config.ts`でRolldownを有効にします。現時点では実験的機能なので、フラグで明示的に有効化する必要があります。

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  experimental: {
    rolldown: true
  }
})
```

これだけです。非常にシンプルですね。

実際にビルドを実行してみます。

```bash
npm run build
```

ビルドは成功しました。出力されたファイルを確認すると、従来のRollupベースのビルドとほぼ同じ構成です。ただし、ソースマップのフォーマットが若干異なっていて、Rolldown固有の最適化パスが追加されているようでした。

## パフォーマンスを計測する

本題はパフォーマンスです。筆者は以下のような計測環境を用意しました。

**テストプロジェクト**:
- React 18 + TypeScript
- 100個のコンポーネント（自動生成）
- 合計2,500行程度のTypeScriptコード
- lodash、date-fns、zustandなどの外部依存あり

計測は5回実行して中央値を取ります。マシンはM1 Mac、メモリ16GB、Node.js 20.10.0です。

```bash
time npm run build
```

結果は以下の通りでした。

| バンドラー | ビルド時間 | 出力サイズ |
|----------|----------|----------|
| Rollup (Vite 4.5) | 4.2s | 143KB |
| Rolldown (Vite 5.0α) | 1.8s | 145KB |

**約2.3倍の高速化**です。これは予想以上でした。

出力サイズはほぼ同じで、gzip後は2KBしか差がありませんでした。つまり、最適化の質を保ったまま速度だけが向上しているということです。

ただし、この結果には注意点があります。テストプロジェクトはあまり複雑ではなく、依存関係も少なめです。実際のプロダクションコードではどうなるか気になります。

## 従来のビルドとの比較

もう少し詳しく見ていきます。

Vite 4.5（Rollupベース）のビルドログを見ると、以下のような処理が行われています。

```
vite v4.5.0 building for production...
✓ 156 modules transformed.
dist/index.html                   0.46 kB
dist/assets/index-abc123.css      2.45 kB │ gzip: 1.21 kB
dist/assets/index-def456.js     143.21 kB │ gzip: 46.23 kB
✓ built in 4.18s
```

一方、Vite 5.0α（Rolldownベース）では、こうなります。

```
vite v5.0.0-alpha.1 building for production...
✓ 156 modules transformed.
dist/index.html                   0.46 kB
dist/assets/index-xyz789.css      2.45 kB │ gzip: 1.21 kB
dist/assets/index-uvw012.js     145.03 kB │ gzip: 46.87 kB
✓ built in 1.76s
```

変換されるモジュール数は同じです。つまり、Rolldownは同じ処理をより高速に実行しているということです。

筆者はここで疑問が湧きました。この高速化はどこから来ているのか？Rustだからというだけではなさそうだということです。

Rolldownのドキュメントを読むと、いくつか興味深い最適化が見つかりました。

まず、**並列処理の強化**です。Rolldownはモジュールグラフの解析を並列化しており、依存関係の解決が大幅に高速化されています。従来のRollupはシングルスレッド処理だったので、ここで差がつくのは納得です。

次に、**インクリメンタルビルド**です。これはまだ実験的ですが、Rolldownはキャッシュを活用して変更されたモジュールのみを再処理します。筆者が試した限りでは、2回目以降のビルドが0.4秒程度まで短縮されました。これは開発体験を大きく改善する可能性があります。

## 実際のプロジェクトで試す

テストプロジェクトで良い結果が出たので、実際の業務プロジェクト（という想定の複雑なデモアプリ）で試してみました。

**プロジェクト構成**:
- React 18 + TypeScript
- 約300個のコンポーネント
- 合計15,000行程度のコード
- 50個程度の外部ライブラリ依存
- emotion、react-query、react-router等の複雑な依存

結果は以下の通りです。

| バンドラー | ビルド時間 | 出力サイズ |
|----------|----------|----------|
| Rollup | 18.4s | 687KB |
| Rolldown | 9.1s | 692KB |

**約2倍の高速化**です。小規模プロジェクトよりも若干倍率は下がりましたが、それでも大幅な改善です。18秒が9秒になるのは体感的にかなり違います。

出力サイズは5KB増えました。gzip後では2KB程度の差なので、実用上は問題なさそうです。

ただし、いくつか気になる点もありました。

まず、**ソースマップの精度**です。デバッグ時にブレークポイントを設定すると、元のコードの位置と若干ずれることがありました。これはRolldownのソースマップ生成が完全ではない可能性があります。本番環境では問題ないですが、開発時は気になるかもしれません。

次に、**プラグインの互換性**です。Viteプラグインの一部（特にRollup専用プラグイン）がRolldownでは動作しませんでした。筆者が使っていたカスタムプラグインも一部修正が必要でした。これはまだアルファ版なので仕方ないですが、将来的に改善されることを期待しています。

:::details Rolldownのプラグインシステムについて
RolldownはRollupと互換性を目指していますが、完全互換ではありません。特に、Rollupの内部APIに依存するプラグインは動作しない可能性があります。Rolldownは独自のプラグインAPIを提供しており、こちらを使う方が確実です。詳細はドキュメント（https://github.com/rolldown-rs/rolldown/blob/main/docs/plugin-api.md）を参照してください。
:::

## ホットリロードの速度

開発時のホットリロード（HMR）の速度も計測してみました。

テスト方法は、`App.tsx`を編集して保存し、ブラウザに反映されるまでの時間を測定します。

| バンドラー | HMR時間 |
|----------|--------|
| esbuild (Vite 4.5) | 47ms |
| Rolldown (Vite 5.0α) | 52ms |

ほぼ同等です。若干Rolldownの方が遅いですが、体感では分かりません。この差は誤差の範囲でしょう。

開発時の体験はesbuildと変わらないので、Rolldownに切り替えても違和感はなさそうです。

## まとめと今後の期待

Vite 5.0のRolldownは、ビルド時間を大幅に短縮しながら出力品質を維持できることが分かりました。

筆者が試した範囲では、以下のような結論です。

**良い点**:
- ビルド時間が約2倍高速化
- 出力サイズはほぼ同等
- 開発時の体験（HMR）も遜色なし
- インクリメンタルビルドの可能性

**気になる点**:
- ソースマップの精度がやや不安定
- プラグイン互換性が完全ではない
- まだアルファ版なので本番投入は様子見

個人的には、Rolldownの方向性は非常に良いと思います。esbuildとRollupの良いとこ取りという発想は理にかなっていますし、開発と本番の差異が減るのは大きなメリットです。

ただし、現時点では安定版を待った方が良さそうです。筆者としては、Vite 5.0の正式リリース後にプロダクション環境で試してみたいと考えています。それまでは開発環境で引き続き実験を続けようと思います。

Rolldownがどこまで成熟するか、また見守っていきたいところです。
